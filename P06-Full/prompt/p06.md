# p05 — OTC API for On-Chain Assets (Polygon Amoy)

Build an OTC API that uses **x402** and **EIP-2612 gasless approvals** to sell on-chain assets  
(e.g., yield-bearing pool tokens, tokenized deposits, ERC-4626-style vault shares) via HTTP,  
while settling payments in **MockEURC** and **MockUSDC** on **Polygon Amoy**.

---

## Context & Assets

- **Network**
  - Polygon Amoy only.

- **Tokens: MockUSDC and MockEURC**
  - Already deployed on Polygon Amoy.
  - **Do not** modify or redeploy these tokens.
  - Import their source as a library from:  
    `/Users/eyal42/Work/Entrepreneurship/SamexLabs/ETHGlobalBuenosAires2025/x402global/P01-Mock_Tokens/src`
  - Read their deployed addresses from environment variables:  
    - `$MOCK_USDC_ADDRESS_POLYGON`  
    - `$MOCK_EURC_ADDRESS_POLYGON`

- **On-chain Asset**
  - The seller’s inventory is an on-chain asset token (e.g., `YieldPoolShare`, `TokenizedDeposit`, ERC-4626 vault shares).
  - Assets are held in a **vault contract** that escrows and releases these tokens on-chain.

- **Uniswap V4 Stack**
  - Use project-specific deployments of:
    - `PoolManager`
    - swap router
    - liquidity router  
    (addresses will be provided).
  - Implement and deploy:
    - A **Uniswap V4 facilitator hook**.
    - Any supporting contracts required to integrate the vault with the Uniswap V4 pool.

- **Languages**
  - Solidity for contracts and deployment/interaction scripts.
  - Python for:
    - HTTP server/client (OTC API),
    - Off-chain facilitator,
    - Event tracker / simple UI.

---

## Roles

1. **Client (Buyer)**
   - Wants to buy a specified amount of the on-chain asset.
   - Pays in **MockEURC** on Polygon Amoy.

2. **Server (Seller)**
   - Sells the on-chain asset.
   - Internally prices the asset in **MockUSDC**.
   - Exposes the HTTP OTC API.

3. **Facilitator (On-chain / Off-chain)**
   - Orchestrates the settlement flow by:
     - Pulling MockEURC via **EIP-2612** permits from the client into a settlement vault.
     - Converting MockEURC → MockUSDC via a **Uniswap V4** pool.
     - Enforcing settlement and vault release rules, including finality checks.

---

## Protocol Flow (x402 + EIP-2612)

1. **Paid HTTP Endpoint**
   - The server exposes a paid endpoint, e.g.:
     - `GET /buy-asset?amount=<desired_asset_amount>`.

2. **Initial HTTP 402 (x402 Payment Requirements)**
   - The client’s first request returns **HTTP 402 Payment Required** with an **x402 Payment Requirements** object describing:
     - Required MockUSDC amount (seller’s price),
     - Settlement token (MockUSDC),
     - Chain (Polygon Amoy),
     - Settlement vault address,
     - Payment deadline and any additional constraints.

3. **Client Pricing & Maximum MockEURC Budget**
   - The client:
     - Queries an off-chain **EUR/USD price API**.
     - Computes the **maximum MockEURC** it is willing to pay for the required MockUSDC amount.
   - The client retries the request to `/buy-asset`, including:
     - An `X-PAYMENT` header that carries a payment payload (including client address, proposed payment in MockEURC, and other metadata).

4. **EIP-2612 Gasless Approval**
   - Payment and asset transfer are executed via EIP-2612 “permit → transferFrom” flow:
     - The **client** signs an **EIP-712 permit** authorizing the **facilitator/puller contract** to spend a specified amount of MockEURC.
     - The **seller** signs an **EIP-712 permit** authorizing the same contract to move the specified amount of the on-chain asset from the seller to the vault.
     - The **server** submits a transaction that:
       - Consumes both permits, and
       - Calls `transferFrom` in the same transaction, pulling:
         - MockEURC from the client into the settlement vault.
         - Asset tokens from the seller into the vault.

5. **Uniswap V4 Conversion via Facilitator Hook**
   - The server triggers a **MockEURC → MockUSDC** swap using a Uniswap V4 pool tied to a facilitator hook:
     - **Pre-swap**:
       - The hook (or facilitator contract) moves the required MockEURC from the **vault** into the `PoolManager` as swap input.
     - **Post-swap**:
       - The hook checks whether the output meets or exceeds the **required MockUSDC amount** specified in the x402 requirements.
       - If the output is insufficient, the hook **reverts** the transaction.
       - On success, the hook:
         - Returns the obtained MockUSDC to the **vault**.
         - Returns any **residual MockEURC** (unused liquidity) to the vault.

6. **Fulfilment, Finality, and Vault Settlement**
   - When the conversion succeeds and the vault holds at least the required MockUSDC amount:
     - The vault emits a **fulfilment event** (e.g., `VaultFunded` / `FulfillmentEvent`) including:
       - Client address,
       - Asset amount,
       - MockUSDC amount,
       - Block number and transaction hash.
   - The **off-chain facilitator**:
     - Detects this event and records the block containing it.
     - Monitors Polygon Amoy until this block is considered **final** under a configured finality policy (e.g., N confirmations or checkpoint status).
   - Only **after finality** is confirmed, the facilitator:
     - Sends an RPC transaction to **open/settle the vault**.
   - When the vault is opened:
     - The required **MockUSDC** is credited to the **seller**.
     - The **on-chain asset** is released from the vault to the **client**.
     - Any **surplus MockEURC** remaining in the vault is refunded to the client.

---

## Observability & Deliverables

- **On-chain Events**
  - Emit clear, structured events for each major step, e.g.:
    - `PaymentRequested`
    - `PermitSigned`
    - `PermitConsumed`
    - `FundsPulled`
    - `SwapRequested`
    - `SwapCompleted`
    - `VaultFunded`
    - `AssetReleased`
    - `RefundSent`

- **Real-Time Event Tracker**
  - Implement a real-time tracker (CLI or simple web UI) that:
    - Subscribes to these events on Polygon Amoy.
    - Displays a live progress view of:
      - x402 payment negotiation,
      - MockEURC → MockUSDC conversion,
      - Vault funding and settlement,
      - Asset delivery and any refunds.

- **Uniswap V4 Integration**
  - Implement a full Uniswap V4 integration on Polygon Amoy using:
    - Provided deployments of `PoolManager`, swap router, and liquidity router.
    - The custom facilitator hook and supporting contracts.

- **End-to-End Demo Goal**
  - Deliver a self-contained demo (contracts + scripts + simple server/client + tracker) that clearly demonstrates:
    - `HTTP 402 (x402)`  
      → `EIP-2612 gasless MockEURC payment`  
      → `MockEURC → MockUSDC conversion via Uniswap V4`  
      → `Vault settlement`  
      → `On-chain asset delivered to the client`.

- **Frontend & Documentation**
  - Create graphical frontend apps that:
    - Track and clarify the progress of each transaction.
    - Are suitable for a live hackathon demo session.
  - Write a comprehensive **README** that explains:
    - Architecture and roles (Client, Server, Facilitator, Vault, Uniswap V4).
    - Setup and deployment steps.
    - How to run the server, client, facilitator, and tracker.
    - How to execute a full end-to-end asset purchase flow.
