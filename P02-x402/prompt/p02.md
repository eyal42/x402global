# p02 — x402 + EIP-2612 OTC API for On-Chain Assets (Polygon Amoy)

Build a minimal OTC API demo that uses **x402** and **EIP-2612 gasless approvals** to sell an **on-chain asset** (e.g., yield-bearing pool tokens, tokenized deposits, ERC-4626-style vault shares) via HTTP, while settling payments in **MockEURC** and **MockUSDC** on **Polygon Amoy**.

---

## Context & Assets

- **Network:** Polygon Amoy only.  
- **Tokens:** `MockUSDC` and `MockEURC` are **already deployed**.
  - **Do not modify or redeploy** these tokens.
  - Import their source as a **library** from `/Users/eyal42/Work/Entrepreneurship/SamexLabs/ETHGlobalBuenosAires2025/x402global/P01-Mock_Tokens/src`
  - Read their deployed addresses from **environment variables** $MOCK_USDC_ADDRESS_POLYGON and $MOCK_EURC_ADDRESS_POLYGON
- **On-chain asset:** The seller’s inventory is an **on-chain asset token** (e.g. `YieldPoolShare`, `TokenizedDeposit`) held in a **vault contract** that escrows and releases these tokens on-chain.
- **Languages:** Code may be written in **Solidity** (contracts + scripts) and/or **Python** (client/server + event tracker).

---

## Roles

1. **Client** – Wants to buy a specified amount of on-chain asset; pays in **MockEURC**.  
2. **Server** – Sells the on-chain asset; internally prices it in **MockUSDC**.  
3. **Facilitator** – On-chain/off-chain logic that:
   - Pulls **MockEURC** via **EIP-2612** from the client into a settlement vault.
   - Simulates conversion from **MockEURC** to **MockUSDC** and orchestrates settlement.

---

## Protocol Flow (x402 + EIP-2612)

1. The server exposes a **paid HTTP endpoint**, e.g. `GET /buy-asset`.
2. The client’s first request returns **HTTP 402** with an **x402 Payment Requirements** object describing how to deposit **MockUSDC (Amoy)** to the server’s settlement vault (token, target amount, chain, deadline, etc.).
3. The client queries an **off-chain EUR/USD price API**, computes the maximum **MockEURC** it is willing to pay for the required MockUSDC amount, and retries the request with an **`X-PAYMENT`** header carrying a payment payload.
4. The payment uses **EIP-2612 gasless approval**:
   - The client signs an **EIP-712 permit** authorizing the facilitator/puller contract to spend a specified amount of **MockEURC**.
   - The server submits a transaction that **consumes the permit and calls `transferFrom`** in the same transaction, pulling MockEURC into the settlement vault (classic `permit → transferFrom` flow).
5. In parallel, the server calls a local **“swap simulator”** object that represents conversion from **MockEURC to MockUSDC** on a UniswapV4 liquidity pool:
   - You **do not implement the liquidity pool**.
   - The simulator exposes a `swap()` function and emits an event when the “conversion” is completed with a resulting MockUSDC amount.
6. When the simulated conversion is “fulfilled” and the effective MockUSDC amount meets or exceeds the required price:
   - The required **MockUSDC** is credited to the vault; any surplus MockEURC is refunded to the client.
7. Once the vault is funded with the required MockUSDC:
   - The vault **releases MockUSDC to the seller**.
   - The vault **releases the on-chain asset tokens** to the client’s address.
   - The server returns **HTTP 200 OK** including confirmation of asset transfer (asset amount, tx hash, final vault balances).

---

## Observability & Deliverables

- Emit **clear on-chain events** for each major step, e.g.:
  - `PaymentRequested`, `PermitSigned`, `PermitConsumed`, `FundsPulled`,  
    `SwapRequested`, `SwapCompleted`, `VaultFunded`, `AssetReleased`, `RefundSent`.
- Implement a **real-time event tracker** (CLI or simple web UI) that:
  - Subscribes to these events on **Polygon Amoy**.
  - Displays a **live progress view** of the x402 payment, conversion simulation, and asset settlement flow.

**Goal:** Deliver a self-contained demo (contracts + scripts + simple server/client + tracker) that runs on **Polygon Amoy** and clearly demonstrates:

> **HTTP 402 (x402) → EIP-2612 gasless EURC payment → simulated EURC→USDC conversion → vault settlement → on-chain asset delivered to the client.**
